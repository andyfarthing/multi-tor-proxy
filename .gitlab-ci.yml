before_script:
  - docker info

docker-build:
  # Use the official docker image.
  image: docker:latest
  stage: build
  services:
    - docker:dind

  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

  # Default branch adds version and latest tags
  script:
    - echo $CI_COMMIT_TAG
    - docker pull $CI_REGISTRY_IMAGE:latest || true
    - docker build --cache-from $CI_REGISTRY_IMAGE:latest --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG --tag $CI_REGISTRY_IMAGE:latest .
    - docker push --all-tags $CI_REGISTRY_IMAGE

  rules:
    # Run only when tagged as semantic release (vX.X.X)
    - if: $CI_COMMIT_TAG =~ /v[0-9|\.]+/
